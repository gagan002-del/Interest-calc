<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interest Calculator with Data Persistence</title>
    <!-- PDF Generation Libraries -->
    <script src="https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/jspdf-autotable@3.5.23/dist/jspdf.plugin.autotable.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f4f7fc;
            color: #333;
        }
        .container {
            max-width: 1100px;
            margin: auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .form-section {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e9ecef;
            margin-bottom: 30px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            align-items: flex-end;
        }
        .form-grid > div { display: flex; flex-direction: column; }
        label { margin-bottom: 8px; font-size: 14px; font-weight: 500; color: #495057; }
        input, select { padding: 10px; border: 1px solid #ced4da; border-radius: 4px; font-size: 15px; box-sizing: border-box; }
        
        .actions {
            margin-top: 20px;
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            gap: 15px;
        }
        button, .button-label {
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background-color 0.3s;
            text-align: center;
        }
        .add-btn { background-color: #28a745; }
        .add-btn:hover { background-color: #218838; }
        
        .export-btn { background-color: #ffc107; color: #212529;}
        .export-btn:hover { background-color: #e0a800; }

        .import-btn { background-color: #17a2b8; }
        .import-btn:hover { background-color: #138496; }
        
        .pdf-btn { background-color: #007bff; }
        .pdf-btn:hover { background-color: #0069d9; }

        .clear-btn { background-color: #dc3545; }
        .clear-btn:hover { background-color: #c82333; }

        table { width: 100%; border-collapse: collapse; margin-top: 30px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: right; }
        th { background-color: #e9ecef; font-weight: 600; text-align: center; }
        tbody tr:nth-child(even) { background-color: #f8f9fa; }
        tbody tr:not(.edit-mode):hover { background-color: #eef2f7; cursor: pointer; }

        tfoot { display: table-footer-group; }
        tfoot td { font-weight: bold; background-color: #e9ecef; }
        .text-left { text-align: left; }
        
        .action-btn { background: none; border: none; cursor: pointer; font-size: 18px; padding: 0 8px; }
        .save-btn { color: #28a745; }
        .cancel-btn { color: #6c757d; }
        .delete-btn { color: #c82333; }
        
        .edit-mode input, .edit-mode select {
             width: 100%;
             padding: 8px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Professional Interest Calculator</h1>

    <div class="form-section">
        <div class="form-grid">
            <div>
                <label for="amount">Amount</label>
                <input type="number" id="amount" placeholder="Enter amount">
            </div>
            <div>
                <label for="from-date">From Date</label>
                <input type="date" id="from-date">
            </div>
            <div>
                <label for="to-date">To Date</label>
                <input type="date" id="to-date">
                 <div style="padding-top: 8px;">
                    <input type="checkbox" id="default-to-date" style="vertical-align: middle;">
                    <label for="default-to-date" style="font-size: 14px; font-weight: normal; display: inline-block; margin: 0; cursor: pointer;">
                        Set 'To Date' as default
                    </label>
                </div>
            </div>
             <div>
                <label for="txn-type">Type</label>
                <select id="txn-type">
                    <option value="debit">Debit (Owed)</option>
                    <option value="credit">Credit (Paid)</option>
                </select>
            </div>
            <div>
                <label for="daily-rate">Daily Rate (%)</label>
                <input type="number" id="daily-rate" step="0.001" value="0.05">
            </div>
        </div>
        <div class="actions">
             <button class="add-btn" onclick="addEntry()">Add Calculation Entry</button>
             <button class="export-btn" onclick="exportData()">Export Data</button>
             <label for="import-file" class="button-label import-btn">Import Data</label>
             <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importData(event)">
             <button class="pdf-btn" onclick="downloadPDF()">Download PDF</button>
             <button class="clear-btn" onclick="clearAllData()">Clear All Data</button>
        </div>
    </div>
    
    <div class="results-box">
        <table>
            <thead>
                <tr>
                    <th class="text-left" style="width: 12%;">From Date</th>
                    <th class="text-left" style="width: 12%;">To Date</th>
                    <th>Debit Amount</th>
                    <th>Credit Amount</th>
                    <th>Days</th>
                    <th class="col-rate">Rate %</th>
                    <th>Interest</th>
                    <th class="col-action">Action</th>
                </tr>
            </thead>
            <tbody id="result-body"></tbody>
            <tfoot>
                <tr>
                    <td colspan="2" class="text-left"><strong>Totals</strong></td>
                    <td id="total-debit">0.00</td>
                    <td id="total-credit">0.00</td>
                    <td class="col-rate"></td>
                    <td><strong>Net Interest Due</strong></td>
                    <td id="total-interest">0.00</td>
                    <td class="col-action"></td>
                </tr>
                 <tr>
                    <td colspan="5" class="text-left"></td>
                    <td><strong>Grand Balance</strong></td>
                    <td id="grand-balance">0.00</td>
                    <td class="col-action"></td>
                </tr>
            </tfoot>
        </table>
    </div>
</div>

<script>
    let transactions = JSON.parse(localStorage.getItem('interestCalculatorDataV2')) || [];
    let editingRowId = null;
    let reportTotals = { totalDebit: 0, totalCredit: 0, totalInterest: 0, grandBalance: 0 };

    function renderAndSave() {
        if(editingRowId) {
            editingRowId = null;
        }
        renderTable();
        saveData();
    }

    function saveData() {
        localStorage.setItem('interestCalculatorDataV2', JSON.stringify(transactions));
    }

    function addEntry() {
        const amount = parseFloat(document.getElementById('amount').value);
        const fromDateStr = document.getElementById('from-date').value;
        const toDateStr = document.getElementById('to-date').value;
        const type = document.getElementById('txn-type').value;
        const dailyRate = parseFloat(document.getElementById('daily-rate').value);

        if (isNaN(amount) || !fromDateStr || !toDateStr || isNaN(dailyRate)) {
            alert("Please fill in all fields correctly.");
            return;
        }
        if (new Date(toDateStr) < new Date(fromDateStr)) {
            alert("'To Date' cannot be earlier than 'From Date'.");
            return;
        }

        const newEntry = {
            id: Date.now(),
            amount, fromDateStr, toDateStr, type, dailyRate
        };
        
        transactions.push(newEntry);
        renderAndSave();
        clearInputs();
    }
    
    function renderTable() {
        transactions.sort((a, b) => new Date(a.fromDateStr) - new Date(b.fromDateStr));

        const tableBody = document.getElementById('result-body');
        tableBody.innerHTML = '';

        let totalDebit = 0, totalCredit = 0, totalInterest = 0;

        transactions.forEach(txn => {
            const isEditing = txn.id === editingRowId;
            const newRow = tableBody.insertRow();
            newRow.className = isEditing ? 'edit-mode' : '';

            const fromDate = new Date(txn.fromDateStr);
            const toDate = new Date(txn.toDateStr);
            
            let days;
            if (txn.type === 'credit') {
                days = Math.ceil((toDate - fromDate) / (1000 * 3600 * 24));
            } else {
                days = Math.ceil((toDate - fromDate) / (1000 * 3600 * 24)) + 1;
            }

            let interest = txn.amount * days * (txn.dailyRate / 100);

            if (txn.type === 'credit') {
                interest *= -1;
                totalCredit += txn.amount;
            } else {
                totalDebit += txn.amount;
            }
            totalInterest += interest;

            if (isEditing) {
                newRow.innerHTML = `
                    <td class="text-left"><input type="date" id="edit-from-${txn.id}" value="${txn.fromDateStr}"></td>
                    <td class="text-left"><input type="date" id="edit-to-${txn.id}" value="${txn.toDateStr}"></td>
                    <td>
                         <select id="edit-type-${txn.id}" style="width: auto; float: left; margin-right: 5px;">
                            <option value="debit" ${txn.type === 'debit' ? 'selected' : ''}>Debit</option>
                            <option value="credit" ${txn.type === 'credit' ? 'selected' : ''}>Credit</option>
                        </select>
                        <input type="number" id="edit-amount-${txn.id}" value="${txn.amount}" style="width: calc(100% - 70px);">
                    </td>
                    <td></td>
                    <td>${days}</td>
                    <td class="col-rate"><input type="number" step="0.001" id="edit-rate-${txn.id}" value="${txn.dailyRate}"></td>
                    <td>${interest.toFixed(2)}</td>
                    <td class="col-action" style="text-align: center; white-space: nowrap;">
                        <button class="action-btn save-btn" onclick="saveRow(${txn.id})">✔</button>
                        <button class="action-btn cancel-btn" onclick="cancelEdit()">✖</button>
                        <button class="action-btn delete-btn" onclick="deleteRow(${txn.id})">🗑</button>
                    </td>
                `;
                const amountCell = newRow.cells[2];
                const creditCell = newRow.cells[3];
                amountCell.colSpan = 2; 
                creditCell.style.display = 'none';

            } else {
                newRow.setAttribute('onclick', `editRow(${txn.id})`);
                newRow.innerHTML = `
                    <td class="text-left">${txn.fromDateStr}</td>
                    <td class="text-left">${txn.toDateStr}</td>
                    <td>${txn.type === 'debit' ? txn.amount.toFixed(2) : '0.00'}</td>
                    <td>${txn.type === 'credit' ? txn.amount.toFixed(2) : '0.00'}</td>
                    <td>${days}</td>
                    <td class="col-rate">${txn.dailyRate.toFixed(3)}%</td>
                    <td>${interest.toFixed(2)}</td>
                    <td class="col-action"></td>
                `;
            }
        });

        const grandBalance = totalDebit + totalInterest - totalCredit;

        document.getElementById('total-debit').innerText = totalDebit.toFixed(2);
        document.getElementById('total-credit').innerText = totalCredit.toFixed(2);
        document.getElementById('total-interest').innerText = totalInterest.toFixed(2);
        document.getElementById('grand-balance').innerText = grandBalance.toFixed(2);

        reportTotals = { totalDebit, totalCredit, totalInterest, grandBalance };
    }

    function editRow(id) {
        editingRowId = id;
        renderTable();
    }

    function cancelEdit() {
        editingRowId = null;
        renderTable();
    }
    
    function saveRow(id) {
        const index = transactions.findIndex(txn => txn.id === id);
        if (index === -1) return;

        const fromDateStr = document.getElementById(`edit-from-${id}`).value;
        const toDateStr = document.getElementById(`edit-to-${id}`).value;
        const amount = parseFloat(document.getElementById(`edit-amount-${id}`).value);
        const type = document.getElementById(`edit-type-${id}`).value;
        const dailyRate = parseFloat(document.getElementById(`edit-rate-${id}`).value);

        if (isNaN(amount) || !fromDateStr || !toDateStr || isNaN(dailyRate)) {
            alert("Please ensure all fields are filled in correctly.");
            return;
        }
        if (new Date(toDateStr) < new Date(fromDateStr)) {
            alert("'To Date' cannot be earlier than 'From Date'.");
            return;
        }
        
        transactions[index] = { ...transactions[index], amount, fromDateStr, toDateStr, type, dailyRate };
        editingRowId = null;
        renderAndSave();
    }

    function deleteRow(id) {
        if (confirm("Are you sure you want to delete this entry?")) {
            transactions = transactions.filter(txn => txn.id !== id);
            editingRowId = null;
            renderAndSave();
        }
    }

    function exportData() {
        if (transactions.length === 0) {
            alert("No data to export."); return;
        }
        const dataStr = JSON.stringify(transactions, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `interest-data-${new Date().toISOString().slice(0, 10)}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;

        if (transactions.length > 0 && !confirm("This will overwrite your current data. Are you sure?")) {
            event.target.value = null; return;
        }

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedData = JSON.parse(e.target.result);
                if (Array.isArray(importedData)) {
                    transactions = importedData;
                    renderAndSave();
                } else { throw new Error("Invalid data format."); }
            } catch (error) {
                alert("Could not import data: " + error.message);
            } finally {
                event.target.value = null;
            }
        };
        reader.readAsText(file);
    }

    function clearAllData() {
        if (transactions.length === 0) {
            alert("There is no data to clear.");
            return;
        }
        if (confirm("Are you sure you want to delete ALL data? This action cannot be undone.")) {
            transactions = [];
            renderAndSave();
        }
    }

    function downloadPDF() {
        if (transactions.length === 0) {
            alert("No data to export to PDF.");
            return;
        }

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();

        const head = [['From Date', 'To Date', 'Debit Amount', 'Credit Amount', 'Days', 'Interest']];
        const body = transactions.map(txn => {
            const fromDate = new Date(txn.fromDateStr);
            const toDate = new Date(txn.toDateStr);

            let days;
            if (txn.type === 'credit') {
                days = Math.ceil((toDate - fromDate) / (1000 * 3600 * 24));
            } else {
                days = Math.ceil((toDate - fromDate) / (1000 * 3600 * 24)) + 1;
            }

            let interest = txn.amount * days * (txn.dailyRate / 100);
            
            if (txn.type === 'credit') {
                interest *= -1;
            }

            return [
                txn.fromDateStr,
                txn.toDateStr,
                txn.type === 'debit' ? txn.amount.toFixed(2) : '0.00',
                txn.type === 'credit' ? txn.amount.toFixed(2) : '0.00',
                days,
                interest.toFixed(2)
            ];
        });

        const { totalDebit, totalCredit, totalInterest, grandBalance } = reportTotals;
        const foot = [
            [
                { content: 'Totals', colSpan: 2, styles: { textAlign: 'left', fontStyle: 'bold'} },
                { content: totalDebit.toFixed(2), styles: { fontStyle: 'bold' } },
                { content: totalCredit.toFixed(2), styles: { fontStyle: 'bold' } },
                { content: 'Net Interest Due:', styles: { halign: 'right', fontStyle: 'bold' } },
                { content: totalInterest.toFixed(2), styles: { fontStyle: 'bold' } }
            ],
            [
                { content: 'Grand Balance', colSpan: 5, styles: { textAlign: 'right', fontStyle: 'bold'} },
                { content: grandBalance.toFixed(2), styles: { fontStyle: 'bold' } }
            ]
        ];

        doc.setFontSize(18);
        doc.text("Interest Calculation Statement", 14, 22);
        doc.setFontSize(11);
        doc.setTextColor(100);
        doc.text("Generated on: " + new Date().toLocaleDateString(), 14, 29);

        doc.autoTable({
            startY: 35,
            head: head,
            body: body,
            foot: foot,
            showFoot: 'lastPage',
            theme: 'striped',
            headStyles: { fillColor: [44, 62, 80] },
            footStyles: { fillColor: [236, 240, 241], textColor: [44, 62, 80], fontStyle: 'bold' },
            didDrawPage: function (data) {
                let str = 'Page ' + doc.internal.getNumberOfPages();
                doc.setFontSize(10);
                doc.text(str, data.settings.margin.left, doc.internal.pageSize.height - 10);
            }
        });

        doc.save(`Interest-Statement-${new Date().toISOString().slice(0, 10)}.pdf`);
    }
    
    function clearInputs() {
        document.getElementById('amount').value = '';
        document.getElementById('from-date').value = '';
        if (!document.getElementById('default-to-date').checked) {
            document.getElementById('to-date').value = '';
        }
    }

    window.onload = function() {
        if (!document.getElementById('to-date').value) {
            document.getElementById('to-date').valueAsDate = new Date();
        }
        renderAndSave();
    };
</script>

</body>
</html>